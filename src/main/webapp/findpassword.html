<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>找回密码</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" type="module"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#7b2cbf',
            secondary: '#4895ef',
            neutral: '#f3f4f6',
            dark: '#1f2937'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .bg-gradient-custom {
        background: linear-gradient(135deg, #7b2cbf 0%, #4895ef 100%);
      }
      .card-shadow {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      .input-focus {
        @apply focus:border-secondary focus:ring-2 focus:ring-secondary/20 focus:outline-none;
      }
      .btn-gradient {
        background: linear-gradient(90deg, #7b2cbf 0%, #4895ef 100%);
      }
      .btn-gradient:hover {
        background: linear-gradient(90deg, #6a24aa 0%, #3d85e0 100%);
      }
      .captcha干扰线 {
        stroke: rgba(123, 44, 191, 0.3);
        stroke-width: 1;
      }
      .captcha文字 {
        fill: #7b2cbf;
        font-weight: bold;
        font-size: 24px;
      }
    }
  </style>
</head>
<body class="font-inter bg-gradient-custom min-h-screen flex items-center justify-center p-4">
<!-- 装饰元素 -->
<div class="fixed inset-0 overflow-hidden pointer-events-none">
  <div class="absolute -top-40 -right-40 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
  <div class="absolute -bottom-20 -left-20 w-60 h-60 bg-white/5 rounded-full blur-3xl"></div>
</div>

<!-- 主卡片 -->
<div class="relative bg-white rounded-2xl card-shadow w-full max-w-md overflow-hidden transform transition-all duration-300 hover:scale-[1.01]">
  <!-- 卡片顶部装饰条 -->
  <div class="h-1.5 bg-gradient-custom"></div>

  <div class="p-8">
    <!-- 标题区域 -->
    <div class="text-center mb-8">
      <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-dark mb-2">找回密码</h1>
      <p class="text-gray-500">请填写以下信息以重置您的密码</p>
    </div>

    <!-- 表单 -->
    <form id="recoveryForm" class="space-y-5">
      <!-- 账号输入 -->
      <div>
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">账号</label>
        <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-user"></i>
                        </span>
          <input
                  type="text"
                  id="username"
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg input-focus transition-all"
                  placeholder="请输入您的账号"
                  required
          >
        </div>
        <p id="usernameError" class="mt-1 text-sm text-red-500 hidden">账号不能为空</p>
      </div>

      <!-- 邮箱输入 -->
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">注册邮箱</label>
        <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-envelope-o"></i>
                        </span>
          <input
                  type="email"
                  id="email"
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg input-focus transition-all"
                  placeholder="请输入您的邮箱地址"
                  required
          >
        </div>
        <p id="emailError" class="mt-1 text-sm text-red-500 hidden">请输入有效的邮箱地址</p>
      </div>

      <!-- 新密码 -->
      <div>
        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
        <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-lock"></i>
                        </span>
          <input
                  type="password"
                  id="newPassword"
                  class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg input-focus transition-all"
                  placeholder="请设置新密码"
                  required
          >
          <button
                  type="button"
                  class="toggle-password absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700"
                  data-target="newPassword"
          >
            <i class="fa fa-eye-slash"></i>
          </button>
        </div>
        <p class="mt-1 text-xs text-gray-500">密码长度至少8位，包含字母和数字</p>
        <p id="passwordError" class="mt-1 text-sm text-red-500 hidden">密码不符合要求</p>
      </div>

      <!-- 确认新密码 -->
      <div>
        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">确认新密码</label>
        <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-lock"></i>
                        </span>
          <input
                  type="password"
                  id="confirmPassword"
                  class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg input-focus transition-all"
                  placeholder="请再次输入新密码"
                  required
          >
          <button
                  type="button"
                  class="toggle-password absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700"
                  data-target="confirmPassword"
          >
            <i class="fa fa-eye-slash"></i>
          </button>
        </div>
        <p id="confirmError" class="mt-1 text-sm text-red-500 hidden">两次输入的密码不一致</p>
      </div>

      <!-- 图形验证码 -->
      <div>
        <label for="captcha" class="block text-sm font-medium text-gray-700 mb-1">图形验证码</label>
        <div class="flex gap-3 items-center">
          <div class="relative flex-1">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-picture-o"></i>
                            </span>
            <input
                    type="text"
                    id="captcha"
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg input-focus transition-all"
                    placeholder="请输入验证码"
                    required
            >
          </div>
          <div class="relative">
            <canvas id="captchaCanvas" width="120" height="45" class="border border-gray-300 rounded-lg cursor-pointer"></canvas>
            <button
                    type="button"
                    id="refreshCaptcha"
                    class="absolute inset-0 flex items-center justify-center bg-black/20 text-white opacity-0 hover:opacity-100 transition-opacity"
            >
              <i class="fa fa-refresh"></i>
            </button>
          </div>
        </div>
        <p id="captchaError" class="mt-1 text-sm text-red-500 hidden">验证码不正确</p>
      </div>

      <!-- 手机/邮箱验证码 -->
      <div>
        <label for="verificationCode" class="block text-sm font-medium text-gray-700 mb-1">短信验证码</label>
        <div class="flex gap-3">
          <div class="relative flex-1">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-shield"></i>
                            </span>
            <input
                    type="text"
                    id="verificationCode"
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg input-focus transition-all"
                    placeholder="请输入验证码"
                    required
            >
          </div>
          <button
                  type="button"
                  id="sendCodeBtn"
                  class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all font-medium whitespace-nowrap"
          >
            获取验证码
          </button>
        </div>
      </div>


      <!-- 提交按钮 -->
      <button
              type="submit"
              class="w-full py-3.5 text-white font-medium rounded-lg btn-gradient transition-all transform hover:translate-y-[-2px] active:translate-y-0 shadow-lg hover:shadow-xl"
      >
        重置密码
      </button>
    </form>

    <!-- 登录链接 -->
    <div class="mt-6 text-center">
      <p class="text-gray-600">
        记得密码了？
        <a href="login.html/" class="text-secondary hover:text-primary font-medium transition-colors">立即登录</a>
      </p>
    </div>
  </div>
</div>

<!-- 成功提示模态框 -->
<div id="successModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden">
  <div class="bg-white rounded-xl p-6 max-w-sm w-full text-center transform transition-all">
    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fa fa-check text-2xl text-green-500"></i>
    </div>
    <h3 class="text-xl font-bold text-gray-800 mb-2">密码重置成功</h3>
    <p class="text-gray-600 mb-6">您的密码已成功重置，请使用新密码登录</p>
    <button id="closeModal" class="px-6 py-2.5 bg-secondary text-white rounded-lg hover:bg-primary transition-colors">
      前往登录
    </button>
  </div>
</div>

<script>
  // 生成随机验证码
  let currentCaptcha = '';
  const captchaCanvas = document.getElementById('captchaCanvas');
  const captchaCtx = captchaCanvas.getContext('2d');
  const refreshCaptchaBtn = document.getElementById('refreshCaptcha');

  // 生成图形验证码
  function generateCaptcha() {
    // 清空画布
    captchaCtx.clearRect(0, 0, captchaCanvas.width, captchaCanvas.height);

    // 填充背景色
    captchaCtx.fillStyle = '#f9fafb';
    captchaCtx.fillRect(0, 0, captchaCanvas.width, captchaCanvas.height);

    // 生成随机字符串
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
    currentCaptcha = '';
    for (let i = 0; i < 4; i++) {
      currentCaptcha += chars.charAt(Math.floor(Math.random() * chars.length));
    }

    // 绘制文字，每个字符位置和旋转角度随机
    for (let i = 0; i < currentCaptcha.length; i++) {
      captchaCtx.fillStyle = `rgb(${Math.floor(Math.random() * 100) + 50}, ${Math.floor(Math.random() * 50)}, ${Math.floor(Math.random() * 200) + 50})`;
      captchaCtx.font = 'bold 24px Arial, sans-serif';
      captchaCtx.save();
      captchaCtx.translate(25 + i * 20, 30);
      captchaCtx.rotate((Math.random() - 0.5) * 0.4); // 轻微旋转
      captchaCtx.fillText(currentCaptcha[i], 0, 0);
      captchaCtx.restore();
    }

    // 绘制干扰线
    for (let i = 0; i < 5; i++) {
      captchaCtx.strokeStyle = `rgba(${Math.floor(Math.random() * 120) + 50}, ${Math.floor(Math.random() * 50) + 30}, ${Math.floor(Math.random() * 200) + 50}, 0.3)`;
      captchaCtx.beginPath();
      captchaCtx.moveTo(Math.random() * captchaCanvas.width, Math.random() * captchaCanvas.height);
      captchaCtx.lineTo(Math.random() * captchaCanvas.width, Math.random() * captchaCanvas.height);
      captchaCtx.lineWidth = Math.random() * 2 + 1;
      captchaCtx.stroke();
    }

    // 绘制干扰点
    for (let i = 0; i < 50; i++) {
      captchaCtx.fillStyle = `rgba(${Math.floor(Math.random() * 150)}, ${Math.floor(Math.random() * 100)}, ${Math.floor(Math.random() * 200)}, 0.2)`;
      captchaCtx.beginPath();
      captchaCtx.arc(Math.random() * captchaCanvas.width, Math.random() * captchaCanvas.height, Math.random() * 2, 0, Math.PI * 2);
      captchaCtx.fill();
    }
  }

  // 刷新验证码
  refreshCaptchaBtn.addEventListener('click', generateCaptcha);
  captchaCanvas.addEventListener('click', generateCaptcha);

  // 初始化验证码
  generateCaptcha();

  // 验证码倒计时功能
  const sendCodeBtn = document.getElementById('sendCodeBtn');
  const emailInput = document.getElementById('email');
  const emailError = document.getElementById('emailError');
  const usernameInput = document.getElementById('username');
  const usernameError = document.getElementById('usernameError');

  sendCodeBtn.addEventListener('click', async function () {
    const email = emailInput.value.trim();
    const username = usernameInput.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    // 验证账号
    if (!username) {
      usernameError.classList.remove('hidden');
      usernameInput.classList.add('border-red-500');

    } else {
      usernameError.classList.add('hidden');
      usernameInput.classList.remove('border-red-500');
    }

    // 验证邮箱格式
    if (!emailRegex.test(email)) {
      emailError.classList.remove('hidden');
      emailInput.classList.add('border-red-500');

    } else {
      emailError.classList.add('hidden');
      emailInput.classList.remove('border-red-500');
    }

    // 验证图形验证码
    const captchaInput = document.getElementById('captcha').value.trim();
    if (captchaInput.toUpperCase() !== currentCaptcha.toUpperCase()) {
      document.getElementById('captchaError').classList.remove('hidden');

    } else {
      document.getElementById('captchaError').classList.add('hidden');
    }

    const param = new URLSearchParams();
    param.append('email', email);
    // 发送验证码请求
    await axios.post("http://localhost:8881/JavaWeb/Verify", param,
            {
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
              }
            })
    // 模拟发送验证码
    console.log(`向邮箱 ${email} 发送验证码`);


    // 开始倒计时
    let countdown = 60;
    sendCodeBtn.disabled = true;
    sendCodeBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
    sendCodeBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
    sendCodeBtn.textContent = `重新发送(${countdown}s)`;

    const timer = setInterval(() => {
      countdown--;
      sendCodeBtn.textContent = `重新发送(${countdown}s)`;

      if (countdown <= 0) {
        clearInterval(timer);
        sendCodeBtn.disabled = false;
        sendCodeBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
        sendCodeBtn.classList.add('bg-gray-100', 'hover:bg-gray-200');
        sendCodeBtn.textContent = '获取验证码';
      }
    }, 1000);


  });

  // 密码显示/隐藏切换
  const togglePasswordBtns = document.querySelectorAll('.toggle-password');

  togglePasswordBtns.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('data-target');
      const passwordInput = document.getElementById(targetId);
      const icon = this.querySelector('i');

      // 切换密码可见性
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);


    });
  });

  // 表单验证和提交
  const recoveryForm = document.getElementById('recoveryForm');
  const newPassword = document.getElementById('newPassword');
  const confirmPassword = document.getElementById('confirmPassword');
  const passwordError = document.getElementById('passwordError');
  const confirmError = document.getElementById('confirmError');
  const successModal = document.getElementById('successModal');
  const closeModal = document.getElementById('closeModal');
  const verifyCode = document.getElementById('verificationCode');


  recoveryForm.addEventListener('submit', async function (e) {
    e.preventDefault();

    // 验证账号
    if (!usernameInput.value.trim()) {
      usernameError.classList.remove('hidden');
      usernameInput.classList.add('border-red-500');
    } else {
      usernameError.classList.add('hidden');
      usernameInput.classList.remove('border-red-500');
    }

    // 验证邮箱
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(emailInput.value.trim())) {
      emailError.classList.remove('hidden');
      emailInput.classList.add('border-red-500');
    } else {
      emailError.classList.add('hidden');
      emailInput.classList.remove('border-red-500');
    }

    // 验证图形验证码
    const captchaInput = document.getElementById('captcha').value.trim();
    if (captchaInput.toUpperCase() !== currentCaptcha.toUpperCase()) {
      document.getElementById('captchaError').classList.remove('hidden');
    } else {
      document.getElementById('captchaError').classList.add('hidden');
    }

    // 验证短信验证码
    if (!document.getElementById('verificationCode').value.trim()) {
      alert('请输入短信验证码');
    }

    // 验证密码
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
    if (!passwordRegex.test(newPassword.value)) {
      passwordError.classList.remove('hidden');
      newPassword.classList.add('border-red-500');

    } else {
      passwordError.classList.add('hidden');
      newPassword.classList.remove('border-red-500');
    }

    // 验证密码一致性
    if (newPassword.value !== confirmPassword.value) {
      confirmError.classList.remove('hidden');
      confirmPassword.classList.add('border-red-500');

    } else {
      confirmError.classList.add('hidden');
      confirmPassword.classList.remove('border-red-500');
    }

    const params = new URLSearchParams();
    params.append('account', usernameInput.value.trim());
    params.append('password', newPassword.value.trim());
    params.append('verifyCode', verifyCode.value.trim());

    console.log(newPassword.value.trim());
    console.log(verifyCode.value.trim());

    // 提交注册信息
    await axios.post("http://localhost:8881/JavaWeb/Findpassword", params,
            {
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
              }
            })
            .then((response) => {
              if (response.data.success) {
                alert("修改成功！即将跳转到登录页面");
                // 实际应用中这里会跳转到登录页面
                window.location.href = "login.html";
              } else {
                alert("修改失败");
              }
            })

  });

  // 关闭模态框
  closeModal.addEventListener('click', function() {
    successModal.classList.add('hidden');
    // 实际应用中这里会跳转到登录页面
    console.log('跳转到登录页面');
  });
  // 点击模态框外部关闭
  successModal.addEventListener('click', function(e) {
    if (e.target === successModal) {
      successModal.classList.add('hidden');
    }
  });

  // 输入图形验证码时移除错误提示
  document.getElementById('captcha').addEventListener('input', function() {
    document.getElementById('captchaError').classList.add('hidden');
  });
</script>
</body>
</html>
